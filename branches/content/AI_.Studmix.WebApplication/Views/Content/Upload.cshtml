@using AI_.Studmix.WebApplication.ViewModels.Content
@model UploadViewModel
@{
    ViewBag.Title = "Upload";
}
<h2>
    Загрузка контента
</h2>
@Html.ValidationSummary()
@using (Html.BeginForm("Upload", "Content", FormMethod.Post, new {enctype = "multipart/form-data"}))
{
    <table>
        <tr class="top">
            <td>
                <p>
                    @Html.LabelFor(m=>m.ContentFiles)
                    <br/>
                    <input type="file" multiple="true" name="ContentFiles" />
                    <br/>
                    @Html.ValidationMessageFor(m => m.ContentFiles)
                </p>
                <p>
                    @Html.LabelFor(m=>m.PreviewContentFiles)
                    <br/>
                    <input type="file" multiple="true" name="PreviewContentFiles" />
                    <br/>
                    @Html.ValidationMessageFor(m => m.PreviewContentFiles)
                </p>
                <p>
                    <input type="submit" value="Сохранить"/>
                </p>
            </td>
            <td >
                <input type="button" value="по умолчанию" id="btnDefault"/>
                @foreach (var property in Model.Properties)
                {
                    var attrs = new Dictionary<string, object> {{"data-property-id", property.ID}};
                    Model.States[property.ID] = null;
                    <div class="editor-field">
                        <span>
                            @property.Name
                        </span>
                        <br />
                        @Html.TextBoxFor(x => x.States[property.ID], attrs)
                    </div>
                }
            </td>
            <td>
               <div class="editor-label">
                    @Html.LabelFor(m => m.Caption)
                </div>
                <div class="editor-field">
                    @Html.TextBoxFor(m => m.Caption)
                    @Html.ValidationMessageFor(m => m.Caption)
                </div>

                <div class="editor-label">
                    @Html.LabelFor(m => m.Description)
                </div>
                <div class="editor-field">
                    @Html.TextAreaFor(m => m.Description)
                    @Html.ValidationMessageFor(m => m.Description)
                </div>

                <div class="editor-label">
                    @Html.LabelFor(m => m.Price)
                </div>
                <div class="editor-field">
                    @Html.TextBoxFor(m => m.Price)
                    @Html.ValidationMessageFor(m => m.Price)
                </div>
            </td>
        </tr>
    </table>
}
<script src="@Url.Content("~/Scripts/jquery.ajax.form.js")" type="text/javascript"> </script>
<script>
    $(function () {
        $("input[data-property-id]").each(function () {
            $(this).focus(UpdateAutocompleteStates);
        });

        $("#btnDefault").click(function() {
            $("#States_1_").val("Россия");
            $("#States_2_").val("Казань");
            $("#States_3_").val("Университет");
            $("#States_4_").val("КНИТУ им. А. Н. Туполева (бывш. КГТУ-КАИ им. Туполева)");
            $("#States_5_").val("Заочная");
        });
    });

    function UpdateAutocompleteStates() {
        var formData = $("form").formSerialize();
        $.ajax(
            {
                url: '/Content/UpdateStates',
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: OnUpdateAutocompleteStatesSuccess
            }
        );
    }

    function OnUpdateAutocompleteStatesSuccess(response) {
        for (var i = 0; i < response.Properties.length; i++) {
            var input = $("input[data-property-id=" + response.Properties[i].ID + "]");
            input.attr("data-autocomplete", response.Properties[i].States);

            input.autocomplete(
                {
                    matchContains: true,
                    minLength: 0,
                    delay: 0,
                    autoFocus: false,
                    source: input.attr("data-autocomplete").split("|")
                }
            );
        }
    }
    
</script>