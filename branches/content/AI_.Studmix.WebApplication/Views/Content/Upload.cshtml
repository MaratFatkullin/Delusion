@using AI_.Studmix.WebApplication.ViewModels.Content
@model UploadViewModel
@{
    ViewBag.Title = "Upload";
}
<h2>
    Загрузка контента
</h2>

@Html.ValidationSummary()
@using (Html.BeginForm("Upload", "Content", FormMethod.Post, new {enctype = "multipart/form-data"}))
{
    <table>
        <tr class="top">
            <td>
                <p>
                    @Html.LabelFor(m => m.ContentFiles)
                    <br/>
                    <input type="file" multiple="true" name="ContentFiles" />
                    <br/>
                    @Html.ValidationMessageFor(m => m.ContentFiles)
                </p>
                <p>
                    @Html.LabelFor(m => m.PreviewContentFiles)
                    <br/>
                    <input type="file" multiple="true" name="PreviewContentFiles" />
                    <br/>
                    @Html.ValidationMessageFor(m => m.PreviewContentFiles)
                </p>
                <p>
                    <input type="submit" value="Сохранить"/>
                </p>
            </td>
            <td >
                <input type="button" value="по умолчанию" id="btnDefault"/>
                @foreach (var property in Model.Properties)
                {
                    var attrs = new Dictionary<string, object> {{"data-property-id", property.ID}};
                    Model.States[property.ID] = null;
                    <div class="editor-field">
                        <span>
                            @property.Name
                        </span>
                        <br />
                        <span>
                            @Html.TextBoxFor(x => x.States[property.ID], attrs)
                            <input type="button"/>
                        </span>
                    </div>
                }
            </td>
            <td>
                <div class="editor-label">
                    @Html.LabelFor(m => m.Caption)
                </div>
                <div class="editor-field">
                    @Html.TextBoxFor(m => m.Caption)
                    @Html.ValidationMessageFor(m => m.Caption)
                </div>

                <div class="editor-label">
                    @Html.LabelFor(m => m.Description)
                </div>
                <div class="editor-field">
                    @Html.TextAreaFor(m => m.Description)
                    @Html.ValidationMessageFor(m => m.Description)
                </div>

                <div class="editor-label">
                    @Html.LabelFor(m => m.Price)
                </div>
                <div class="editor-field">
                    @Html.TextBoxFor(m => m.Price)
                    @Html.ValidationMessageFor(m => m.Price)
                </div>
            </td>
        </tr>
    </table>
    @Html.Hidden("targetPropertyId")
}

@section scripts{
    @Url.Script("jquery.ajax.form.js")
}

<script type="text/javascript">
    $(function() {
        $("input[data-property-id]").each(function() {
            var button = $(this).siblings("input[type=button]");
            var propertyId = $(this).attr("data-property-id");
            button.click(function() {
                UpdateAutocompleteStates(propertyId);
            });
        });

        $("#btnDefault").click(function() {
            $("#States_1_").val("Россия");
            $("#States_2_").val("Казань");
            $("#States_3_").val("Университет");
            $("#States_4_").val("КНИТУ им. А. Н. Туполева (бывш. КГТУ-КАИ им. Туполева)");
            $("#States_5_").val("Заочная");
        });
    });

    function UpdateAutocompleteStates(propertyId) {
        $("#targetPropertyId").val(propertyId);
        var formData = $("form").formSerialize();
        $.ajax(
            {
                url: '/Content/UpdateStates',
                type: 'POST',
                data: formData,
                dataType: 'json',
                success: OnUpdateAutocompleteStatesSuccess
            }
        );
    }

    function OnUpdateAutocompleteStatesSuccess(response) {
        var targetPropertyId = $("#targetPropertyId").val();
        var input = $("input[data-property-id=" + targetPropertyId + "]");
        input.attr("data-autocomplete", response);

        input.autocomplete(
            {
                matchContains: true,
                minLength: 0,
                delay: 0,
                autoFocus: false,
                source: input.attr("data-autocomplete").split("|")
            }
        );

        input.autocomplete("search", "");
    }
    
</script>